<!DOCTYPE html>
<video id="remote" autoplay playsinline muted style="width:40vw; background:#000"></video>
<script>
const pc = new RTCPeerConnection();
const ws = new WebSocket(`ws://${location.host}/ws/room1`);

ws.addEventListener('open', () => {
  ws.send(JSON.stringify({ type: 'hello' }));
});

pc.ontrack = e => {
  remote.srcObject = e.streams[0];
  remote.onloadedmetadata = () => remote.play().catch(() => {});
};

pc.onicecandidate = e =>
  e.candidate && ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));

ws.onmessage = async ({ data }) => {
  const m = JSON.parse(data);
  if (m.type === 'offer') {
    await pc.setRemoteDescription(m);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    ws.send(JSON.stringify(ans));
  } else if (m.type === 'candidate') {
    pc.addIceCandidate(m.candidate);
  }
};
</script>
